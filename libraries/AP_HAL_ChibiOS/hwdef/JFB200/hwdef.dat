# hw definition file for processing by chibios_hwdef.py
# for the JFB200 hardware

# board ID for firmware load
APJ_BOARD_ID 1200

# MCU class and specific type
MCU STM32H7xx STM32H755xx
define CORE_CM7
#define SMPS_PWR

# crystal frequency 24MHz
OSCILLATOR_HZ 24000000

# the H755 has 128k sectors
# bootloader is installed at 128kb offset
FLASH_BOOTLOADER_LOAD_KB 128
FLASH_RESERVE_START_KB 128
FLASH_SIZE_KB 2048

# USB setup
# USB_VENDOR 0x0A8E  # JAE
USB_STRING_MANUFACTURER "Japan Aviation Electronics Industry Ltd."
USB_STRING_PRODUCT "JFB-200"

# ChibiOS system timer
STM32_ST_USE_TIMER 2

# enable board sub-type detection
define CONFIG_HAL_BOARD HAL_BOARD_CHIBIOS
#define HAL_CHIBIOS_ARCH_FMUV6 1
#define AP_FEATURE_BOARD_DETECT 1
#define CONFIG_HAL_BOARD_SUBTYPE HAL_BOARD_SUBTYPE_CHIBIOS_FMUV5
#define HAL_CHIBIOS_ARCH_FMUV5 1

env OPTIMIZE -O2

# order of UARTs (and USB)
# SERIAL    | 0  |  1  |  2  |  3   |  4   |  5  |  6  |  7   |  8   |  9 |
SERIAL_ORDER OTG1 UART7 UART5 USART2 USART1 UART4 UART8 USART6 USART3 OTG2
# UART8  is RX only for RC_IN
# USART6 is TX only for SBUS_OUT

# serial port for stdout, set SERIAL8_PROTOCOL 5(GPS) when using
# The value for STDOUT_SERIAL is a serial device name, and must be for a 
# serial device for which pins are defined in this file. For example, SD3
# is for USART3 (SD3 == "serial device 3" in ChibiOS).
STDOUT_SERIAL SD3
STDOUT_BAUDRATE 921600

# default to all pins low to avoid ESD issues
DEFAULTGPIO OUTPUT LOW PULLDOWN

# USB OTG1 SERIAL0
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1
# default the 2nd interface to MAVLink2
define HAL_OTG2_PROTOCOL SerialProtocol_MAVLink2

# pins for SWD debugging
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# telem1 
PE8  UART7_TX  UART7 SPEED_VERYLOW
PE10 UART7_CTS UART7 SPEED_VERYLOW
PE7  UART7_RX  UART7 SPEED_VERYLOW
PF8  UART7_RTS UART7 SPEED_VERYLOW

# telem2
PC12 UART5_TX  UART5 SPEED_VERYLOW
PC9  UART5_CTS UART5 SPEED_VERYLOW
PD2  UART5_RX  UART5 SPEED_VERYLOW
PC8  UART5_RTS UART5 SPEED_VERYLOW

# telem3
PA3  USART2_RX  USART2  SPEED_VERYLOW
#PD3  USART2_CTS USART2  SPEED_VERYLOW  # TL6
#PD4  USART2_RTS USART2  SPEED_VERYLOW  # TL7
PD5  USART2_TX  USART2  SPEED_VERYLOW

# GPS1
PB6  USART1_TX USART1 SPEED_VERYLOW
PB7  USART1_RX USART1 SPEED_VERYLOW

# uart4 for GPS2
PH13 UART4_TX UART4 SPEED_VERYLOW
PH14 UART4_RX UART4 SPEED_VERYLOW

# TX Only, for SBUS OUT
PG14 USART6_TX USART6 SPEED_VERYLOW


# RX Only, for RC input
PE0  UART8_RX UART8 SPEED_VERYLOW  # UART8_RX_SBUS
PE1  UART8_TX UART8 SPEED_VERYLOW  # TL10

# debug uart
PD8  USART3_TX USART3 SPEED_VERYLOW NODMA
PD9  USART3_RX USART3 SPEED_VERYLOW NODMA

# ADC
PA0   BATT_VOLTAGE_SENS  ADC1 SCALE(1)  # ADC1_16
PA4   BATT_CURRENT_SENS  ADC1 SCALE(1)  # ADC1_18
PF5   BATT2_VOLTAGE_SENS ADC3 SCALE(1)  # ADC3_4
PF12  BATT2_CURRENT_SENS ADC1 SCALE(1)  # ADC1_6

# setup scaling defaults for supplied power brick
define HAL_BATT_VOLT_SCALE  1 #18.182
define HAL_BATT_CURR_SCALE  1 #36.364
define HAL_BATT2_VOLT_SCALE 1 #18.182
define HAL_BATT2_CURR_SCALE 1 #36.364
define HAL_BATT_VOLT_PIN  16
define HAL_BATT_CURR_PIN  18
define HAL_BATT2_VOLT_PIN 4
define HAL_BATT2_CURR_PIN 6

# Now the VDD sense pin. This is used to sense primary board voltage.
PH4  VDD_5V_SENS ADC3 SCALE(2)  # ADC3_15
define ANALOG_VCC_5V_PIN 15
define HAL_HAVE_BOARD_VOLTAGE 1
PA9  VBUS_RESERVED INPUT

# JFB200 has SERVORAIL ADC
PF11  SCALED_V3V3               ADC1 SCALE(2)  # ADC1_2
PH3   FMU_SERVORAIL_VCC_SENS    ADC3 SCALE(2)  # ADC3_14

PC0  RSSI_IN ADC1 SCALE(1)       # ADC1_10
define RSSI_ANA_PIN 10

PF6 ADC3_6V6 ADC3 SCALE(2)       # ADC3_8
PC3 ADC1_3V3 ADC1 SCALE(1)       # ADC1_13

# This defines an output pin which will default to output HIGH. It is
# a pin that enables peripheral power on this board. It starts in the
# off state, then is pulled low to enable peripherals in
# peripheral_power_enable()
PG10 nVDD_5V_HIPOWER_EN         OUTPUT HIGH  # VDD_5V_HIGHPOWER_CEn
PK1  nVDD_5V_PERIPH_EN          OUTPUT HIGH  # VDD_5V_PERIPH_CEn
PJ2   VDD_3V3_SENSORS_EN        OUTPUT LOW   
PG0   VDD_3V3_SENSORS2_EN       OUTPUT LOW   # VDD_3V3_GPS_EN
PJ4   VDD_3V3_SENSORS3_EN       OUTPUT LOW   # BUZZER_VCC_EN
PI13 nVDD_3V3_SD_CARD_EN        OUTPUT HIGH  # HEATER_CEn
# To Do : nVDD_5V_HEATER_EN needed to create

# Control of Spektrum power pin
# no SPEKTRUM_RC pin so this is controlled manually
PA15  SPEKTRUM_PWR OUTPUT HIGH GPIO(69)   # VDD_3V3_SPEKTRUM_EN
define HAL_GPIO_SPEKTRUM_PWR 69
define HAL_SPEKTRUM_PWR_ENABLED 1

#Checked in Analogin.cpp -> MAV_POWER_STATUS
PG1   VDD_BRICK_nVALID      INPUT
PG2   VDD_BRICK2_nVALID     INPUT
PG3   VBUS_nVALID           INPUT
PF10  VDD_5V_HIPOWER_nOC    INPUT  # VDD_5V_HIPOWER_nFAULT
PJ15  VDD_5V_PERIPH_nOC     INPUT  # VDD_5V_PERIPH_FAULTn
PD11  5V_HEATER_FAULTn      INPUT
# To Do : Vdd_5V_HEATER_VCC needed to create

# controlled manually
PK4   GPIO_CAN_SILENT   OUTPUT PUSHPULL LOW   # CAN_OEn


# SPI1
PA5   SPI1_SCK          SPI1  SPEED_VERYLOW
PB5   SPI1_MOSI         SPI1  SPEED_VERYLOW
PA6   SPI1_MISO         SPI1  SPEED_VERYLOW
PK5   FRAM_SPI1_CS      CS    SPEED_VERYLOW  # FM25V02A-DGTR
PJ3   IMU3_SPI1_CS      CS    SPEED_VERYLOW  # ICM-42688-P

# SPI2
PI1   SPI2_SCK          SPI2  SPEED_VERYLOW
PI3   SPI2_MOSI         SPI2  SPEED_VERYLOW
PC2   SPI2_MISO         SPI2  SPEED_VERYLOW
PF2   BARO1_SPI2_CS     CS    SPEED_VERYLOW  # BMP390 on FSU
PI4   IMU1_SPI2_CS      CS    SPEED_VERYLOW  # ICM-45686 on FSU

# SPI3
PB2   SPI3_MOSI         SPI3  SPEED_VERYLOW
PC10  SPI3_SCK          SPI3  SPEED_VERYLOW
PC11  SPI3_MISO         SPI3  SPEED_VERYLOW
PI10  IMU2_SPI3_CS      CS    SPEED_VERYLOW  # SCH16T-K01 on FSU
PI9   BARO2_SPI3_CS     CS    SPEED_VERYLOW  # ICP-20100  on FSU

# SPI4
PE12  SPI4_SCK          SPI4  SPEED_VERYLOW
PE6   SPI4_MOSI         SPI4  SPEED_VERYLOW
PE13  SPI4_MISO         SPI4  SPEED_VERYLOW
PH15  BARO3_SPI4_CS     CS    SPEED_VERYLOW  # MS561101BA03-50
PG6   EEPROM_SPI4_CS    CS    SPEED_VERYLOW  # AT25512-TH-T

# SPI5
PF7   SPI5_SCK          SPI5  SPEED_VERYLOW
PH7   SPI5_MISO         SPI5  SPEED_VERYLOW
PJ10  SPI5_MOSI         SPI5  SPEED_VERYLOW
PE2   EXT_SPI5_CS       CS    SPEED_VERYLOW


# SPI devices
SPIDEV icm42688     SPI1 DEVID1  IMU3_SPI1_CS     MODE3  20*MHZ 20*MHZ  # ICM-42688-P (24MHz max)
SPIDEV ramtron      SPI1 DEVID2  FRAM_SPI1_CS     MODE3  38*MHZ 38*MHZ  # FM25V02A-DGTR (40MHz max)

SPIDEV icm45686     SPI2 DEVID1  IMU1_SPI2_CS     MODE3  20*MHZ 20*MHZ  # ICM-45686 on FSU  (24MHz max)
SPIDEV bmp390       SPI2 DEVID2  BARO1_SPI2_CS    MODE3  8*MHZ  8*MHZ   # BMP390 on FSU (10MHz max)

SPIDEV sch16t       SPI3 DEVID1  IMU2_SPI3_CS     MODE0  10*MHZ 10*MHZ  # SCH16T-K01 on FSU (10.5MHz max)
SPIDEV icp20100     SPI3 DEVID2  BARO2_SPI3_CS    MODE3  10*MHZ 10*MHZ  # ICP-20100  on FSU (12MHz max)

SPIDEV ms5611       SPI4 DEVID1  BARO3_SPI4_CS    MODE3  18*MHZ 18*MHZ  # MS561101BA03-50 (20MHz max)
SPIDEV at25512      SPI4 DEVID2  EEPROM_SPI4_CS   MODE3  8*MHZ  8*MHZ   # AT25512-TH-T (10MHz max)


# JFB200 has 3 IMUs
# IMU devices for JFB200. The JFB200 board has SCH16T and ICM-42688, ICM-45686.
IMU SCH16T          SPI:sch16t      ROTATION_NONE     # SCH16T-K01 on FSU
IMU Invensensev3    SPI:icm45686    ROTATION_YAW_90   # ICM-45686 on FSU
IMU Invensensev3    SPI:icm42688    ROTATION_ROLL_180 # ICM-42688-P

# JFB200 has 3 BAROs
BARO BMP388         SPI:bmp390      # BMP390 on FSU
BARO ICP201XX       SPI:icp20100    # ICP-20100  on FSU
BARO MS56XX         SPI:ms5611      # MS561101BA03-50

#define HAL_SPI_CHECK_CLOCK_FREQ

define HAL_DEFAULT_INS_FAST_SAMPLE 7

# PWM output pins
# we need to disable DMA on the last 2 FMU channels
# as timer 12 doesn't have a TIMn_UP DMA option
PE9  TIM1_CH1  TIM1  PWM(1)   SPEED_VERYLOW
PJ11 TIM1_CH2  TIM1  PWM(2)   SPEED_VERYLOW
PA10 TIM1_CH3  TIM1  PWM(3)   SPEED_VERYLOW
PE14 TIM1_CH4  TIM1  PWM(4)   SPEED_VERYLOW
PC6  TIM3_CH1  TIM3  PWM(5)   SPEED_VERYLOW
PC7  TIM3_CH2  TIM3  PWM(6)   SPEED_VERYLOW
PB0  TIM3_CH3  TIM3  PWM(7)   SPEED_VERYLOW
PB1  TIM3_CH4  TIM3  PWM(8)   SPEED_VERYLOW
PD12 TIM4_CH1  TIM4  PWM(9)   GPIO(50) SPEED_VERYLOW
PD13 TIM4_CH2  TIM4  PWM(10)  GPIO(51) SPEED_VERYLOW
PD14 TIM4_CH3  TIM4  PWM(11)  GPIO(52) SPEED_VERYLOW
PD15 TIM4_CH4  TIM4  PWM(12)  GPIO(53) SPEED_VERYLOW
PI5  TIM8_CH1  TIM8  PWM(13)  GPIO(54) SPEED_VERYLOW
PI6  TIM8_CH2  TIM8  PWM(14)  GPIO(55) SPEED_VERYLOW
PI7  TIM8_CH3  TIM8  PWM(15)  GPIO(56) SPEED_VERYLOW
PI2  TIM8_CH4  TIM8  PWM(16)  GPIO(57) SPEED_VERYLOW
PK2  PWM_OEn                  OUTPUT HIGH  
PJ6  PWM_VOLTAGE_SEL_5V_3Vn   OUTPUT LOW GPIO(3)
define HAL_GPIO_PWM_VOLT_PIN 3
define HAL_GPIO_PWM_VOLT_3v3 0

# GPIOs
PE11 FMU_CAP1 INPUT GPIO(58)
PB11 FMU_CAP2 INPUT GPIO(59)

# CAN bus
PD0  CAN1_RX CAN1 SPEED_VERYLOW  # FD_CAN1_RX
PD1  CAN1_TX CAN1 SPEED_VERYLOW  # FD_CAN1_TX
PB12 CAN2_RX CAN2 SPEED_VERYLOW  # FD_CAN2_RX
PB13 CAN2_TX CAN2 SPEED_VERYLOW  # FD_CAN2_TX
PG7  TERMCAN1 OUTPUT  HIGH  SPEED_VERYLOW
PG8  TERMCAN2 OUTPUT  HIGH  SPEED_VERYLOW

# I2C buses
define HAL_I2C_MAX_CLOCK 400000

# I2C1, external
PB8 I2C1_SCL I2C1
PB9 I2C1_SDA I2C1

# I2C2, external
PF1 I2C2_SCL I2C2
PF0 I2C2_SDA I2C2

# I2C3, IST8310 Internal, BMM350 Internal on FSU
PA8 I2C3_SCL I2C3 SPEED_VERYLOW
PH8 I2C3_SDA I2C3 SPEED_VERYLOW

# I2C4, external
PF14 I2C4_SCL I2C4
PF15 I2C4_SDA I2C4

# order of I2C buses
I2C_ORDER I2C3 I2C1 I2C2 I2C4
define HAL_I2C_INTERNAL_MASK 1

# this board is very tight on DMA channels. To allow for more UART DMA
# we disable DMA on I2C. This also prevents a problem with DMA on I2C
# interfering with IMUs
NODMA I2C*
define STM32_I2C_USE_DMA FALSE

# builtin compass on JAE JFB200
#define HAL_COMPASS_DISABLE_IST8310_INTERNAL_PROBE
define HAL_SKIP_AUTO_INTERNAL_I2C_PROBE
#define HAL_PROBE_EXTERNAL_I2C_COMPASSES
COMPASS IST8310 I2C:ALL_INTERNAL:0x0E false ROTATION_NONE
COMPASS BMM350  I2C:ALL_INTERNAL:0x14 false ROTATION_ROLL_180

COMPASS IST8310 I2C:ALL_EXTERNAL:0x0E true  ROTATION_ROLL_180_YAW_90

# armed indication
PB10 nARMED OUTPUT HIGH  SPEED_VERYLOW

# microSD support
PD6  SDMMC2_CK  SDMMC2 SPEED_LOW
PD7  SDMMC2_CMD SDMMC2 SPEED_LOW
PB14 SDMMC2_D0  SDMMC2 SPEED_LOW
PB15 SDMMC2_D1  SDMMC2 SPEED_LOW
PB3  SDMMC2_D2  SDMMC2 SPEED_LOW
PB4  SDMMC2_D3  SDMMC2 SPEED_LOW
define FATFS_HAL_DEVICE SDCD2
PC13 SD_CARD_IN INPUT

# safety
# allow to have a dedicated safety switch pin
PD10 LED_SAFETY OUTPUT HIGH         # SAFETY_LEDn
PG9  SAFETY_IN  INPUT  PULLDOWN     # SAFETY_SWITCH_IN
define HAL_HAVE_SAFETY_SWITCH 1

# LEDs
PE3 LED_RED   OUTPUT OPENDRAIN GPIO(70) LOW SPEED_VERYLOW
PE4 LED_GREEN OUTPUT OPENDRAIN GPIO(71) LOW SPEED_VERYLOW
PE5 LED_BLUE  OUTPUT OPENDRAIN GPIO(72) LOW SPEED_VERYLOW


# setup for "AP_BoardLED" RGB LEDs
define AP_NOTIFY_GPIO_LED_2_ENABLED 1
define HAL_GPIO_A_LED_PIN 72
define HAL_GPIO_B_LED_PIN 70
#define HAL_GPIO_C_LED_PIN 71


# PWM output for buzzer
PF9 TIM14_CH1 TIM14 ALARM SPEED_VERYLOW


# RC input (PPM)
PH6 TIM12_CH1 TIM12 RCININT PULLDOWN LOW

# enable RAMTRON parameter storage
define HAL_STORAGE_SIZE 32768
define HAL_WITH_RAMTRON 1



DMA_PRIORITY SDMMC* UART* USART* ADC* SPI* TIM*

# enable FAT filesystem support (needs a microSD defined via SDMMC)
define HAL_OS_FATFS_IO 1

# enable DFU reboot for installing bootloader
# note that if firmware is build with --secure-bl then DFU is
# disabled
ENABLE_DFU_BOOT 1

# External watchdog gpio
PI0 EXT_WDOG OUTPUT LOW SPEED_VERYLOW
define EXT_WDOG_INTERVAL_MS 50

# Ethernet
PA1  ETH_RMII_REF_CLK  ETH1  SPEED_VERYLOW
PA2  ETH_MDIO          ETH1  SPEED_VERYLOW
PA7  ETH_RMII_CRS_DV   ETH1  SPEED_VERYLOW
PC1  ETH_MDC           ETH1  SPEED_VERYLOW
PC4  ETH_RMII_RXD0     ETH1  SPEED_VERYLOW
PC5  ETH_RMII_RXD1     ETH1  SPEED_VERYLOW
PG11 ETH_RMII_TX_EN    ETH1  SPEED_VERYLOW
PG13 ETH_RMII_TXD0     ETH1  SPEED_VERYLOW
PG12 ETH_RMII_TXD1     ETH1  SPEED_VERYLOW
#PH2  EXT_ETH_POWER_EN  OUTPUT HIGH
PH2 GPIO_ETH_ENABLE OUTPUT GPIO(113) HIGH SPEED_VERYLOW
define HAL_GPIO_ETH_ENABLE 113

define BOARD_PHY_ID  MII_LAN8742A_ID
define BOARD_PHY_RMII

# Refer to https://maclookup.app/vendors/japan-aviation-electronics-industry-ltd
# Note, lower 3 bytes (ADDR3,4,5) will be replaced with the platform UUID
define AP_NETWORKING_DEFAULT_MAC_ADDR "00:E0:5E:00:00:00"

# set protocol for UART7 to SerialProtocol_PPP
#define DEFAULT_SERIAL7_PROTOCOL SerialProtocol_PPP
#define DEFAULT_SERIAL7_BAUD 8000000

define AP_NETWORKING_DEFAULT_STATIC_IP_ADDR "192.168.100.1"
define AP_NETWORKING_DEFAULT_STATIC_NETMASK "255.255.255.0"
define AP_NETWORKING_DEFAULT_STATIC_GW_ADDR "192.168.100.254"
#define AP_NETWORKING_BACKEND_PPP 1


# HEATER
# Setup the IMU heater
define HAL_HAVE_IMU_HEATER 1
define HAL_IMU_TEMP_DEFAULT 45
define HAL_IMUHEAT_P_DEFAULT 50
define HAL_IMUHEAT_I_DEFAULT 0.07
define HAL_IMU_TEMP_MARGIN_LOW_DEFAULT 5 

PI12  IMU_TEMP_CTL OUTPUT LOW SPEED_VERYLOW GPIO(80)

#HEATER define
define HAL_HEATER_GPIO_PIN 80


# compensate for magnetic field generated by the heater on JFB200 IST8310
define HAL_HEATER_MAG_OFFSET_IST8310 AP_HAL::Device::make_bus_id(AP_HAL::Device::BUS_TYPE_I2C,0,0x0E,0x0A),Vector3f(-35,0,130)

# compensate for magnetic field generated by the heater on JFB200 BMM350
define HAL_HEATER_MAG_OFFSET_BMM350 AP_HAL::Device::make_bus_id(AP_HAL::Device::BUS_TYPE_I2C,0,0x14,0x17),Vector3f(-75,-15,-330)

define HAL_HEATER_MAG_OFFSET {HAL_HEATER_MAG_OFFSET_IST8310, HAL_HEATER_MAG_OFFSET_BMM350}
